using System;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace UnitConverterDesktop
{
    public partial class Form1 : Form
    {
        private HttpClient _httpClient;
        private const string BaseUrl = "https://localhost:7258/api/Conversion/";

        public Form1()
        {
            InitializeComponent();
            InitializeHttpClient();
            InitializeComboBoxes();
        }

        private void InitializeHttpClient()
        {
            var handler = new HttpClientHandler();
            handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
            _httpClient = new HttpClient(handler);
        }

        private void InitializeComboBoxes()
        {
            // Configurar ComboBox de conversiones
            cmbConversion.Items.AddRange(new object[]
            {
                "Seleccione una conversión",
                "Centímetros a Metros",
                "Metros a Centímetros",
                "Metros a Kilómetros",
                "Toneladas a Libras",
                "Kilogramos a Libras",
                "Gramos a Kilogramos",
                "Celsius a Fahrenheit",
                "Fahrenheit a Celsius",
                "Celsius a Kelvin"
            });
            cmbConversion.SelectedIndex = 0;
        }

        private async void btnConvert_Click(object sender, EventArgs e)
        {
            if (cmbConversion.SelectedIndex == 0)
            {
                MessageBox.Show("Por favor seleccione una conversión", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (!double.TryParse(txtValue.Text, out double value))
            {
                MessageBox.Show("Por favor ingrese un valor numérico válido", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            try
            {
                btnConvert.Enabled = false;
                btnConvert.Text = "Convirtiendo...";

                double resultado = await ConvertValue(cmbConversion.SelectedIndex, value);

                string unidadOrigen = GetUnitFromConversion(cmbConversion.SelectedIndex, true);
                string unidadDestino = GetUnitFromConversion(cmbConversion.SelectedIndex, false);

                lblResult.Text = $"{value} {unidadOrigen} = {resultado} {unidadDestino}";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error en la conversión: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                btnConvert.Enabled = true;
                btnConvert.Text = "Convertir";
            }
        }

        private async Task<double> ConvertValue(int conversionIndex, double value)
        {
            return conversionIndex switch
            {
                1 => await PostAsync<double>("centimetros-a-metros", value),
                2 => await PostAsync<double>("metros-a-centimetros", value),
                3 => await PostAsync<double>("metros-a-kilometros", value),
                4 => await PostAsync<double>("tonelada-a-libra", value),
                5 => await PostAsync<double>("kilogramo-a-libra", value),
                6 => await PostAsync<double>("gramo-a-kilogramo", value),
                7 => await PostAsync<double>("celsius-a-fahrenheit", value),
                8 => await PostAsync<double>("fahrenheit-a-celsius", value),
                9 => await PostAsync<double>("celsius-a-kelvin", value),
                _ => throw new ArgumentException("Conversión no válida")
            };
        }

        private string GetUnitFromConversion(int conversionIndex, bool isSource)
        {
            return conversionIndex switch
            {
                1 => isSource ? "cm" : "m",
                2 => isSource ? "m" : "cm",
                3 => isSource ? "m" : "km",
                4 => isSource ? "ton" : "lb",
                5 => isSource ? "kg" : "lb",
                6 => isSource ? "g" : "kg",
                7 => isSource ? "°C" : "°F",
                8 => isSource ? "°F" : "°C",
                9 => isSource ? "°C" : "K",
                _ => ""
            };
        }

        private async Task<T> PostAsync<T>(string endpoint, double value)
        {
            var json = JsonSerializer.Serialize(value);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _httpClient.PostAsync(BaseUrl + endpoint, content);

            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<T>>(
                    responseContent,
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                );

                if (apiResponse?.Success == true)
                {
                    return apiResponse.Data;
                }
                else
                {
                    throw new Exception($"Error del servidor: {apiResponse?.Message}");
                }
            }
            else
            {
                throw new Exception($"Error HTTP: {response.StatusCode}");
            }
        }

        private void btnClear_Click(object sender, EventArgs e)
        {
            txtValue.Clear();
            lblResult.Text = "Resultado aparecerá aquí";
            cmbConversion.SelectedIndex = 0;
        }

        private async void btnHealthCheck_Click(object sender, EventArgs e)
        {
            try
            {
                var response = await _httpClient.GetAsync(BaseUrl.Replace("Conversion/", "Conversion/health"));
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("✅ Servidor conectado correctamente", "Estado del Servidor",
                                  MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    MessageBox.Show("❌ No se puede conectar al servidor", "Error",
                                  MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"❌ Error de conexión: {ex.Message}", "Error",
                              MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }

    public class ApiResponse<T>
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public T Data { get; set; }
        public DateTime Timestamp { get; set; }
    }
}