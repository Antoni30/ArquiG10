using System;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Drawing;
using System.Net;
using System.Net.Sockets;

namespace UnitConverterDesktop
{
    public partial class Form1 : Form
    {
        private HttpClient _httpClient;
        private string BaseUrl;
        private string _selectedCategory = "Temperatura";

        public Form1()
        {
            InitializeComponent();

            // show login dialog first
            using (var login = new LoginForm())
            {
                var result = login.ShowDialog(this);
                if (result != DialogResult.OK || !login.IsAuthenticated)
                {
                    // close the app if not authenticated
                    this.BeginInvoke((Action)(() => this.Close()));
                    return;
                }
            }

            InitializeHttpClient();
            InitializeComboBoxes();
            UpdateCategoryVisuals();
        }

        private void InitializeHttpClient()
        {
            var handler = new HttpClientHandler();
            handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
            _httpClient = new HttpClient(handler);

            var ip = GetLocalIPAddress();
            BaseUrl = $"https://{ip}:7258/api/Conversion/";
        }

        private string GetLocalIPAddress()
        {
            try
            {
                var host = Dns.GetHostEntry(Dns.GetHostName());
                foreach (var ip in host.AddressList)
                {
                    if (ip.AddressFamily == AddressFamily.InterNetwork && !IPAddress.IsLoopback(ip))
                    {
                        return ip.ToString();
                    }
                }

                // fallback to loopback if no network adapters with an IPv4 address found
                return "127.0.0.1";
            }
            catch
            {
                return "127.0.0.1";
            }
        }

        private void InitializeComboBoxes()
        {
            // Default to Temperature conversions
            SetConversionsForCategory(_selectedCategory);
        }

        private void SetConversionsForCategory(string category)
        {
            cmbConversion.Items.Clear();
            cmbConversion.Items.Add("-- SELECCIONE UNA OPERACIÓN --");
            if (category == "Longitud")
            {
                cmbConversion.Items.AddRange(new object[]
                {
                    "Centímetros a Metros",
                    "Metros a Centímetros",
                    "Metros a Kilómetros"
                });
            }
            else if (category == "Masa")
            {
                cmbConversion.Items.AddRange(new object[]
                {
                    "Toneladas a Libras",
                    "Kilogramos a Libras",
                    "Gramos a Kilogramos"
                });
            }
            else // Temperatura
            {
                cmbConversion.Items.AddRange(new object[]
                {
                    "Celsius a Fahrenheit",
                    "Fahrenheit a Celsius",
                    "Celsius a Kelvin"
                });
            }

            cmbConversion.SelectedIndex = 0;
            lblConversion.Text = $"Seleccionar Conversión (Tipo: {category}):";
        }

        private void UpdateCategoryVisuals()
        {
            // Simple visual feedback: bold selected category button
            btnLength.Font = new Font(btnLength.Font, _selectedCategory == "Longitud" ? FontStyle.Bold : FontStyle.Regular);
            btnMass.Font = new Font(btnMass.Font, _selectedCategory == "Masa" ? FontStyle.Bold : FontStyle.Regular);
            btnTemperature.Font = new Font(btnTemperature.Font, _selectedCategory == "Temperatura" ? FontStyle.Bold : FontStyle.Regular);
        }

        private void btnLength_Click(object sender, EventArgs e)
        {
            _selectedCategory = "Longitud";
            SetConversionsForCategory(_selectedCategory);
            UpdateCategoryVisuals();
        }

        private void btnMass_Click(object sender, EventArgs e)
        {
            _selectedCategory = "Masa";
            SetConversionsForCategory(_selectedCategory);
            UpdateCategoryVisuals();
        }

        private void btnTemperature_Click(object sender, EventArgs e)
        {
            _selectedCategory = "Temperatura";
            SetConversionsForCategory(_selectedCategory);
            UpdateCategoryVisuals();
        }

        // Owner-draw handler to show the first item as a gray placeholder
        private void cmbConversion_DrawItem(object sender, DrawItemEventArgs e)
        {
            try
            {
                if (e.Index < 0)
                    return;

                var combo = sender as ComboBox;
                string text = combo?.Items[e.Index].ToString() ?? string.Empty;

                // Draw the background
                e.DrawBackground();

                bool isPlaceholder = e.Index == 0;

                Color foreColor = isPlaceholder ? Color.Gray : combo.ForeColor;
                Font drawFont = isPlaceholder ? new Font(combo.Font, FontStyle.Italic) : combo.Font;

                using (var brush = new SolidBrush(foreColor))
                {
                    e.Graphics.DrawString(text, drawFont, brush, e.Bounds.X + 2, e.Bounds.Y + 2);
                }

                // Dispose temporary font if created
                if (isPlaceholder)
                {
                    drawFont.Dispose();
                }

                e.DrawFocusRectangle();
            }
            catch
            {
                // ignore drawing errors
            }
        }

        private async void btnConvert_Click(object sender, EventArgs e)
        {
            if (cmbConversion.SelectedIndex == 0)
            {
                MessageBox.Show("Por favor seleccione una conversión", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (!double.TryParse(txtValue.Text, out double value))
            {
                MessageBox.Show("Por favor ingrese un valor numérico válido", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            try
            {
                btnConvert.Enabled = false;
                btnConvert.Text = "Convirtiendo...";

                double resultado = await ConvertValue(cmbConversion.SelectedIndex, value);

                string unidadOrigen = GetUnitFromConversion(cmbConversion.SelectedIndex, true);
                string unidadDestino = GetUnitFromConversion(cmbConversion.SelectedIndex, false);

                lblResult.Text = $"{value} {unidadOrigen} = {resultado} {unidadDestino}";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error en la conversión: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                btnConvert.Enabled = true;
                btnConvert.Text = "Convertir";
            }
        }

        private async Task<double> ConvertValue(int conversionIndex, double value)
        {
            // Map selection index relative to current category
            // index 0 is placeholder, so start at 1
            int idx = conversionIndex;
            if (idx == 0) throw new ArgumentException("Conversión no válida");

            if (_selectedCategory == "Longitud")
            {
                return idx switch
                {
                    1 => await PostAsync<double>("centimetros-a-metros", value),
                    2 => await PostAsync<double>("metros-a-centimetros", value),
                    3 => await PostAsync<double>("metros-a-kilometros", value),
                    _ => throw new ArgumentException("Conversión no válida")
                };
            }
            else if (_selectedCategory == "Masa")
            {
                return idx switch
                {
                    1 => await PostAsync<double>("tonelada-a-libra", value),
                    2 => await PostAsync<double>("kilogramo-a-libra", value),
                    3 => await PostAsync<double>("gramo-a-kilogramo", value),
                    _ => throw new ArgumentException("Conversión no válida")
                };
            }
            else // Temperatura
            {
                return idx switch
                {
                    1 => await PostAsync<double>("celsius-a-fahrenheit", value),
                    2 => await PostAsync<double>("fahrenheit-a-celsius", value),
                    3 => await PostAsync<double>("celsius-a-kelvin", value),
                    _ => throw new ArgumentException("Conversión no válida")
                };
            }
        }

        private string GetUnitFromConversion(int conversionIndex, bool isSource)
        {
            int idx = conversionIndex;
            if (idx == 0) return string.Empty;

            if (_selectedCategory == "Longitud")
            {
                return idx switch
                {
                    1 => isSource ? "cm" : "m",
                    2 => isSource ? "m" : "cm",
                    3 => isSource ? "m" : "km",
                    _ => ""
                };
            }
            else if (_selectedCategory == "Masa")
            {
                return idx switch
                {
                    1 => isSource ? "ton" : "lb",
                    2 => isSource ? "kg" : "lb",
                    3 => isSource ? "g" : "kg",
                    _ => ""
                };
            }
            else // Temperatura
            {
                return idx switch
                {
                    1 => isSource ? "°C" : "°F",
                    2 => isSource ? "°F" : "°C",
                    3 => isSource ? "°C" : "K",
                    _ => ""
                };
            }
        }

        private async Task<T> PostAsync<T>(string endpoint, double value)
        {
            var json = JsonSerializer.Serialize(value);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _httpClient.PostAsync(BaseUrl + endpoint, content);

            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<T>>(
                    responseContent,
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                );

                if (apiResponse?.Success == true)
                {
                    return apiResponse.Data;
                }
                else
                {
                    throw new Exception($"Error del servidor: {apiResponse?.Message}");
                }
            }
            else
            {
                throw new Exception($"Error HTTP: {response.StatusCode}");
            }
        }

        private void btnClear_Click(object sender, EventArgs e)
        {
            txtValue.Clear();
            lblResult.Text = "Resultado aparecerá aquí";
            cmbConversion.SelectedIndex = 0;
        }

        private async void btnHealthCheck_Click(object sender, EventArgs e)
        {
            try
            {
                var response = await _httpClient.GetAsync(BaseUrl.Replace("Conversion/", "Conversion/health"));
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("? Servidor conectado correctamente", "Estado del Servidor",
                                  MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    MessageBox.Show("? No se puede conectar al servidor", "Error",
                                  MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"? Error de conexión: {ex.Message}", "Error",
                              MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        public class ApiResponse<T>
        {
            public bool Success { get; set; }
            public string Message { get; set; } = string.Empty;
            public T Data { get; set; }
            public DateTime Timestamp { get; set; }
        }
    }
}